<!DOCTYPE html>
<meta charset="utf-8">

<title>INFO 3300 Project 2</title>

<link href="https://fonts.googleapis.com/css?family=Tajawal|Tajawal+Lato" rel="stylesheet">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/default.min.css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-geo.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
<!-- Compiled and minified CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.2/css/materialize.min.css">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="styles/styles.css">


<body>
<div class = "main">
    <div style = "height: 10px"></div>
    <hr>
    <div class = "title">
      <h1>Matchups of NBA Teams</h1>
      <h3>How NBA teams fared against each other during the last 4 NBA Seasons</h3>
    </div>

    <div class = "centered" style = "position: fixed; top: 5%; right: 1.25%">
      <h3 class = "centered"> Season:</h3>
      <h3 id = "seasonLabel">2017-2018</h3>
      <h3><span id = "firstTeam">___</span> vs. <span id = "secondTeam">___</span></h3><br>
    </div>

  <div id = "seasons" class = "seasonInput" style = "position: fixed; top: 40%; right: 25px ">
  <tr>
    <td> <a style = "background: gray" onclick = "changeBackground('gray', 1)" class = "home-cta btn" id = "twentyeighteen"> 2017-2018 </a> </td>
    <td> <a onclick = "changeBackground('#ffd700', 2)" class = "home-cta btn" id = "twentyseventeen"> 2016-2017 </a> </td>
    <td> <a onclick = "changeBackground('#800000', 3)" class = "home-cta btn" id = "twentysixteen"> 2015-2016 </a> </td>
    <td> <a onclick = "changeBackground('#ffd700', 4)" class = "home-cta btn" id = "twentyfifteen"> 2014-2015 </a> </td>
    <br>
    <br>
    <td> <a onclick = "conditionalReset()" class = "home-cta btn" id = "reset"> Reset </a> </td>
  </tr>
  </div>

  <hr>
  <div class = "dataSection card-panel" id= "inputs" height = "600px">
    <div class = "left">
        <!-- Show map -->
        <svg width ="550" height ="500"/>
    </div>
    <div class = "right">
      <div class="card-content black-text">
        <span class="card-title"><h2>Team Matchup<h2></span>
            <div id = "teamTable">
            </div>
      </div>
    </div>
  </div>

<!-- flight times -->
  <hr>
  <div id = "General" class = "card-panel infoCard">
    <h1> General Team Stats </h1>
    <h2 id="generalSeasonLabel" class = "centered"> 2017-2018</h3>
    <svg id="general" width="600" height="450">
      <image id="teamOnePic" height="100" width="100" />
      <text id="vs" x="275" y="50" font-size="35">VS.</text>
      <image id="otherTeamPic" height="100" width="100"/>
      <text id="teamOneWins" />
      <text id="otherTeamWins"/>
    </svg>

  </div>

  <!-- Delays -->
  <hr class = "infoCard">
  <div id = "Matchup" class = "card-panel infoCard">
      <h1> Season Matchup Record </h1>
      <svg id="matchup" width="600" height="450">
        <text font-size="20" color="black" x="0" y="50">Game 1: </text>
        <text id="matchupscore" x="0" y="50" font-size="20">Score</text>
        <text id="matchupgame2" x="0" y="150" font-size="20"></text>
        <text id="matchup2score" x="0" y="200" font-size="20">Score</text>
      </svg>
      <!-- TODO: Display the scores using a transition circle or something.
      inspiration here:
      http://jsfiddle.net/chrisJamesC/9ChXk/18/
      -->
  </div>

<hr class = "infoCard">
<div id = "Summary" class = "card-panel infoCard">
  <h1>Season Leaders</h1>
  <!-- TODO: Not necessary, but append the summary data, including season MVP, ROTY, Rebounding leader, scoring leader, assist leader -->
</div>


<hr class = "infoCard">
<div style = "height: 25px"></div>
<h3> Rachel Shim, Trevor Smith, and Michael Wang </h3>
<div style = "height: 25px"></div>


<script>

// preparing the US map
var svg = d3.select("svg");
var projection = d3.geoAlbersUsa().scale(2000);
var path = d3.geoPath().projection(projection);

// variables containing dataset data.
// teams has each team's season record by year,
// as well as the GPS coordinates
var teams;
// These variables have each of the head to head Matchups
// they have every single game from the corresponding season
// with the number representing the year the season ends
// ie. fifteen = the 2014-2015 season
var fifteen;
var sixteen;
var seventeen;
var eighteen;

var season = 1;

var abbr = ['ATL', 'BKN', 'BOS', 'CHA', 'CHI', 'CLE', 'DAL', 'DEN', 'DET', 'GSW', 'HOU', 'IND', 'LAC', 'LAL', 'MEM', 'MIA', 'MIL', 'MIN', 'NOP', 'NYK', 'OKC', 'ORL', 'PHI', 'PHX', 'POR', 'SAC', 'SAS', 'TOR', 'UTA', 'WAS']


var nbaCities = ['Atlanta', 'Brooklyn', 'Boston', 'Charlotte', 'Chicago', 'Cleveland', 'Dallas', 'Denver', 'Detroit', 'Golden State', 'Houston', 'Indiana', 'Los Angeles', 'Los Angeles', 'Memphis', 'Miami', 'Milwaukee', 'Minnesota', 'New Orleans', 'New York', 'Oklahoma City', 'Orlando', 'Philadelphia', 'Phoenix', 'Portland', 'Sacramento', 'San Antonio', 'Toronto', 'Utah', 'Washington']

var teamNames = ['Hawks', 'Nets', 'Celtics', 'Hornets', 'Bulls', 'Cavaliers', 'Mavericks', 'Nuggets', 'Pistons', 'Warriors', 'Rockets', 'Pacers', 'Clippers', 'Lakers', 'Grizzlies', 'Heat', 'Bucks', 'Timberwolves', 'Pelicans', 'Knicks', 'Thunder', 'Magic', '76ers', 'Suns', 'Trail Blazers', 'Kings', 'Spurs', 'Raptors', 'Jazz', 'Wizards']

var abbrDict = {
  'Atlanta Hawks' : 'ATL',
   'Brooklyn Nets' :'BKN',
   'Boston Celtics' : 'BOS',
   'Charlotte Hornets' : 'CHA',
   'Chicago Bulls' : 'CHI',
   'Cleveland Cavaliers' : 'CLE',
   'Dallas Mavericks' : 'DAL',
   'Denver Nuggets' : 'DEN',
   'Detroit Pistons' : 'DET',
   'Golden State Warriors' : 'GSW',
   'Houston Rockets' : 'HOU',
   'Indiana Pacers' : 'IND',
   'Los Angeles Clippers' : 'LAC',
   'Los Angeles Lakers' : 'LAL',
   'Memphis Grizzlies' : 'MEM',
   'Milwaukee Bucks': 'MIL',
   'Miami Heat' : 'MIA',
   'Minnesota Timberwolves' : 'MIN',
   'New Orleans Pelicans' : 'NOP',
   'New York Knicks' : 'NYK',
   'Oklahoma City Thunder' : 'OKC',
   'Orlando Magic' : 'ORL',
   'Philadelphia 76ers' : 'PHI','Phoenix Suns' : 'PHX',
   'Portland Trail Blazers' : 'POR',
   'Sacramento Kings' : 'SAC', 'San Antonio Spurs' : 'SAS', 'Toronto Raptors' : 'TOR', 'Utah Jazz' : 'UTA',
   'Washington Wizards' : 'WAS'
}

var team1 = "";
var team2 = "";


var teamOne = "";
var otherTeam = "";
var ontime;
var fare;


var pairs = [];
var dict = {};
// setting up ability to select two teams
function matchups(){
  for (var a = 0; a < nbaCities.length; a++){
    pairs.push(nbaCities[a] + " " + teamNames[a]);
    dict[abbr[a]] = []
  }
}

// creating team selection table
function populateCities(){
  // TODO: make it so that the teams selected stay
  // highlighted until reset or another two teams are picked

  var tableDiv = d3.select("#teamTable");
  var table = tableDiv.append("TABLE");
  var tableBody = table.append("TBODY");

  var x = 0;

  for (var i = 0; i < 10; i++ ) {

    var tr = tableBody.append("TR");
    for(var j = 0; j < 3; j++){
      var td = tr.append("TD")
      .attr("id", abbrDict[pairs[x]])
      .text(pairs[x])
      .style("height", "30px").style("width", "100px")
      .attr("class", "teamTD");

      x = x + 1;
    }
}


  var tds= d3.selectAll("TD.teamTD");
  tds
  .each(function(td){
      var t = d3.select(this);
      t.on("click", function(){
        var curr = t.attr("id")
        // Selecting First Team upon First Click
        if(t.classed("unselectable")) {
          return;
        }

        if((teamOne == "" && otherTeam == "") || (teamOne != "" && otherTeam != "")) {
          reset();
          var unavail = dict[curr];

          unavail.forEach(function(code){
            var port = d3.select("#" + code);
            port.classed("unselectable", true);
          })
          teamOne = curr;
          d3.select("#firstTeam").text(teamOne);
          d3.select("#secondTeam").text("___")
          otherTeam = "";
          return;
        }
        // Selecting Second Team upon Second Click
        else if(otherTeam == "") {
          otherTeam =  curr;
          d3.select("#secondTeam").text(otherTeam);
          d3.selectAll(".unselectable").classed("unselectable", false);
          plotAll();
        }
  })
  })
}

function plotAll() {
  var year = document.getElementById("seasonLabel").innerHTML;
  d3.selectAll(".infoCard")
  .classed("infoCardVisible", true)
  .classed("infoCard", false);
  displayPath(teamOne, otherTeam);
  displayStats(teamOne, otherTeam, year);
  displayMatchup(teamOne, otherTeam, year);
}

function reset() {
  d3.selectAll(".info").remove()
  d3.selectAll("button.airportButton")
  .attr("disabled", null);
}

matchups();
populateCities();

//Display functions
function displayCities() {
   var cities = svg.selectAll("circle").data(pairs);

   cities.exit().remove;
   cities = cities.enter().append("circle")
   .attr("class", "stadium")
   .attr("r", 4)
   .style("fill", "#ffd700")
   .merge(cities);


   cities
   .attr("cx", function(d) {
     var coord = [teams["$" + abbrDict[d]].Longitude,teams["$" + abbrDict[d]].Latitude]

     return projection(coord)[0];
   })
   .attr("cy", function(d) {
     var coord = [teams["$" + abbrDict[d]].Longitude,teams["$" + abbrDict[d]].Latitude]
     return projection(coord)[1];
   })
   .on("mouseover", function(d) {
     var x = d3.select(this);
     x.attr("r", 12)
     .style("fill", "rgba(255,223,0, .5)");
     d3.select("#cityLabel")
     .text(d)
     .attr("visibility", "visible");
   })
   .on("mouseout", function(d) {
     var x = d3.select(this);
     x.attr("r", 4)
     .style("fill", "#ffd700");
     d3.select("#cityLabel")
     .attr("visibility", "hidden");
   });
 }

//  draw path
function displayPath(teamOne, teamTwo) {
    coord1 = projection([teams["$" + teamOne].Longitude,teams["$" + teamOne].Latitude])
    coord2 = projection([teams["$" + teamTwo].Longitude,teams["$" + teamTwo].Latitude])

    var midpoint = [(coord1[0] + coord2[0])/2, (coord1[1] + coord2[1])/2]

    var curve = "M " + coord1[0] + " " + coord1[1] + " " + coord2[0] + " " + coord2[1]

    d3.select("svg")
    .append("path")
    .attr("d", curve)
    .attr("class", "info")
    .attr("fill", "transparent")
    .attr('stroke', "rgb(0,0,255)")
    .attr('stroke-width', "4")
    .attr("stroke-dasharray", ("10,10"))
    .style("fill", "#FFFFFF");
 }

function displayStats(teamOne, otherTeam, year) {
   document.getElementById("generalSeasonLabel").innerHTML = year;

   d3.select("#teamOnePic")
   .attr("xlink:href","assets/"+teamOne+".png")
   .attr("x","50px")
   .attr("height","100px");

   d3.select("#otherTeamPic")
   .attr("xlink:href","assets/"+otherTeam+".png")
   .attr("height","100px")
   .attr("x","450px");

   if (year == "2017-2018") {
     var wins1 = teams["$"+teamOne].y2018;
     var wins2 = teams["$"+otherTeam].y2018;
   }

   if (year == "2016-2017") {
      var wins1 = teams["$"+teamOne].y2017;
      var wins2 = teams["$"+otherTeam].y2017;
   }

   if (year == "2015-2016") {
     var wins1 = teams["$"+teamOne].y2016;
     var wins2 = teams["$"+otherTeam].y2016;
   }

   if (year == "2014-2015") {
     var wins1 = teams["$"+teamOne].y2015;
     var wins2 = teams["$"+otherTeam].y2015;
   }

  var div = d3.select("#teamOneWins")
  .attr("x","60")
  .attr("y","120")
  .text(teamOne + " wins: " + wins1);

  var div = d3.select("#otherTeamWins")
  .attr("x","450")
  .attr("y","120")
  .text(otherTeam + " wins: " + wins2);

  var total = 0;

  for (i=0;i<9;i++){

    if (i>7){
      var j = 7;
    }
    else{
      var j = 0;
    }

    while (j<10){
      if ((total)<wins1){
        var team1ballcolor = "orange";
      }
      else{
        var team1ballcolor = "grey";
      }

      if ((total)<wins2){
        var team2ballcolor = "orange";
      }
      else{
        var team2ballcolor = "grey";
      }

      if (i>7){
        var last = 140;
      }
      else{
        var last = 0;
      }

      var div = d3.select("#general")
      .append("rect")
      .attr("x",j*20-last)
      .attr("y",(140+i*20))
      .attr("height","15")
      .attr("width","15")
      .style("fill",team1ballcolor);

      var div = d3.select("#general")
      .append("rect")
      .attr("x",400+j*20-last)
      .attr("y",(140+i*20))
      .attr("height","15")
      .attr("width","15")
      .style("fill",team2ballcolor);

      j++;
      total++;
    }
  }
 }

function valuesToArray(object) {
  //helper function to turn nested objects into arrays
   return Object.keys(object).map(function (d) { return object[d]; });
 }

function displayMatchup(homeTeam, awayTeam, year) {
  // TODO: show the head to head matchups. year will help you choose which var to used
  // fifteen, sixteen, seventeen, or eighteen. You will then go into that var and search
  // for the games that have the homeTeam as Team1 and the awayTeam as Team2, and you will
  // create a list of PTS1 and PTS2 pairs that will each be displayed
  var home = nbaCities[abbr.indexOf(homeTeam)] +" " + teamNames[abbr.indexOf(homeTeam)];
  var away = nbaCities[abbr.indexOf(awayTeam)] +" " + teamNames[abbr.indexOf(awayTeam)];

  if (year=="2017-2018"){
    var val = eighteen.find(function(d) {
      return d.key == home;
    })
  }
  if (year=="2016-2017"){
    var val = seventeen.find(function(d) {
      return d.key == home;
    })
  }
  if (year=="2015-2016"){
    var val = sixteen.find(function(d) {
      return d.key == home;
    })
  }
  if (year=="2014-2015"){
    var val = fifteen.find(function(d) {
      return d.key == home;
    })
  }

  var homegames = valuesToArray(val);

  var val = homegames[1].find(function(d) {
    return d.key == away;
  })

  var games = valuesToArray(val);

  var text = homeTeam + " Scored: " + games[1][0].PTS1 +
  " " + awayTeam + " Scored: " + games[1][0].PTS2;
  d3.select("#matchupscore")
  .attr("x","0")
  .attr("y","100")
  .attr("font-size","20")
  .text(text);

  //games[1][0] is game 1 of home team vs away team1
  //games[1][1] is game 2, they only have 2 games max
  //games[1][0].PTS1 is Home Team's points in game 1
  //games[1][0].PTS2 is Away Team's points in game 1 etc.
  if(games[1].length>1){
    var text2 = homeTeam + " Scored: " + games[1][1].PTS1 +
    " " + awayTeam + " Scored: " + games[1][1].PTS2;

    d3.select("#matchup2score")
    .text(text2);

    d3.select("#matchupgame2")
    .text("Game 2:");
  }
  else{
    d3.select("#matchup2score")
    .text("None Played");

    d3.select("#matchupgame2")
    .text("Game 2:");
  }



}

function displayLeaders(year) {
  // TODO: display the stats for the season summary leaders

}




function rgbToHex(col)
{
    if(col.charAt(0)=='r')
    {
        col=col.replace('rgb(','').replace(')','').split(',');
        var r=parseInt(col[0], 10).toString(16);
        var g=parseInt(col[1], 10).toString(16);
        var b=parseInt(col[2], 10).toString(16);
        r=r.length==1?'0'+r:r; g=g.length==1?'0'+g:g; b=b.length==1?'0'+b:b;
        var colHex='#'+r+g+b;
        return colHex;
    }
}

function changeBackground(color, numQuarter) {
  // Array of the <a> tags
   var curr = document.getElementById("seasons").querySelectorAll(".home-cta");
   var winterColor = "#808080";
   var springColor = "#ffd700";
   var summerColor = "#800000";
   var fallColor = "#0000FF";
   var defaultColor = "#FFFFFF";
   var colors = [winterColor,springColor,summerColor,fallColor];
   var x = curr[numQuarter-1];

  //  change button color
  // button pressed already
  if(rgbToHex(x.style.backgroundColor) != colors[numQuarter-1]) {
    season = numQuarter;
    for (var i = 0; i<colors.length; i++) {
      if (curr[i] != x) {
        curr[i].style.backgroundColor = defaultColor;
      }
      else{
        curr[i].style.backgroundColor = colors[i];
        document.getElementById("seasonLabel").innerHTML = curr[i].innerText;
        document.getElementById("firstTeam").innerHTML = teamOne;
        document.getElementById("secondTeam").innerHTML = otherTeam;
      }
    }
    if(teamOne != "" && otherTeam != "") {
      reset();
      plotAll();
    }
    else{
      document.getElementById("firstTeam").innerHTML = "___";
      document.getElementById("secondTeam").innerHTML = "___";
    }
  }
}

function resetColors() {
  document.body.style.background = "#FFFFFF";
  var curr = document.getElementById("seasons").querySelectorAll(".home-cta");
  for(var i = 0; i < curr.length; i++) {
    curr[i].style.backgroundColor = "#FFFFFF";
  }
  document.getElementById("twentyeighteen").style.backgroundColor = 'gray';
}

function conditionalReset() {
  reset();
  resetColors();
  d3.selectAll(".infoCardVisible")
  .classed("infoCard", true)
  .classed("infoCardVisible", false);
  teamOne = "";
  otherTeam = "";
  document.getElementById("seasonLabel").innerHTML = "2017-2018";
  document.getElementById("firstTeam").innerHTML = "___";
  document.getElementById("secondTeam").innerHTML = "___";
}




//Initial Loading
d3.queue()
.defer(d3.csv, "nba2014-2015.csv")
.defer(d3.csv, "nba2015-2016.csv")
.defer(d3.csv, "nba2016-2017.csv")
.defer(d3.csv, "nba2017-2018.csv")
.defer(d3.csv, "nbateams.csv")
.defer(d3.json, "us.json")
.await(function(error, rawFifteen, rawSixteen, rawSeventeen, rawEighteen, rawTeams, rawUS) {
    fifteen = d3.nest()
      .key(function(d) {return d.Team1;})
      .key(function(d) {return d.Team2;})
      .entries(rawFifteen);

    sixteen = d3.nest()
      .key(function(d) {return d.Team1;})
      .key(function(d) {return d.Team2;})
      .entries(rawSixteen);

    seventeen = d3.nest()
      .key(function(d) {return d.Team1;})
      .key(function(d) {return d.Team2;})
      .entries(rawSeventeen);

    eighteen = d3.nest()
      .key(function(d) {return d.Team1;})
      .key(function(d) {return d.Team2;})
      .entries(rawEighteen);



    teams = d3.map(rawTeams, function(d) {
      return d.Abbreviation;
    });

    teams.each(function(d) {
      d.Longitude = Number(d.Longitude)
      d.Latitude = Number(d.Latitude)
    });

    states = topojson.feature(rawUS, rawUS.objects.states);

    //Making map
    projection.fitExtent([[0,0], [svg.attr("width"), svg.attr("height")]], states);

    var pathGenerator = d3.geoPath().projection(projection);

    var paths = svg.selectAll("path.state").data(states.features);
    paths.enter().append("path").attr("class", "state")
    .merge(paths)
    .attr("d", function (state) {
      return pathGenerator(state)
    })
    .style("stroke", "#FFFFFF").style("fill", "darkblue");
    // ^^^ colors gray: #778899 white: #FFFFFF

    svg.append("text")
    .attr("visibility", "hidden")
    .attr("x", svg.attr("width")/2)
    .attr("y", 50)
    .attr("font-size", 24)
    .attr("text-anchor", "middle")
    .attr("id", "cityLabel");

    displayCities();
});


</script>
</div>
</body>
</html>
